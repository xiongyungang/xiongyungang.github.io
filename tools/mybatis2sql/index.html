<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MyBatis SQL åˆå¹¶å·¥å…·</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f7f9fc;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 20px;
      height: 70vh;
    }
    .panel {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: bold;
      margin-bottom: 8px;
      color: #444;
    }
    textarea {
      flex: 1;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      resize: none;
      background-color: #fff;
      box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
      font-family: 'Courier New', Courier, monospace;
    }
    button {
      padding: 10px 16px;
      background-color: #007cba;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      transition: background-color 0.2s;
    }
    button#copyBtn {
      background-color: #28a745;
    }
    button:hover {
      opacity: 0.9;
    }
    .status {
      margin-top: 10px;
      min-height: 20px;
      font-size: 14px;
      color: #d9534f;
    }
    .success {
      color: #28a745;
    }
  </style>
</head>
<body>

  <h1>ğŸ” MyBatis SQL å‚æ•°åˆå¹¶å·¥å…·</h1>
  <p style="text-align:center;color:#666;">å°† SSM é¡¹ç›®ä¸­ MyBatis æ§åˆ¶å°è¾“å‡ºçš„ SQL å’Œ Parameters è‡ªåŠ¨åˆå¹¶æˆå®Œæ•´ SQL</p>

  <div class="container">
    <!-- è¾“å…¥é¢æ¿ -->
    <div class="panel">
      <label for="inputLog">ç²˜è´´ä¸¤è¡Œæ—¥å¿—ï¼š</label>
      <textarea id="inputLog" placeholder="è¯·ç²˜è´´ä»¥ä¸‹æ ¼å¼çš„æ—¥å¿—ï¼š
Preparing: SELECT * FROM user WHERE id = ? AND name = ? AND create_time > ?
Parameters: 123(Long), å¼ ä¸‰(String), 2024-01-01 00:00:00(Timestamp)"></textarea>
      <button onclick="processSql()">âœ… è‡ªåŠ¨ç”Ÿæˆ SQL</button>
      <div id="statusLeft" class="status"></div>
    </div>

    <!-- è¾“å‡ºé¢æ¿ -->
    <div class="panel">
      <label for="outputSql">å®Œæ•´ SQLï¼š</label>
      <textarea id="outputSql" readonly placeholder="åˆå¹¶åçš„ SQL å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
      <button id="copyBtn" onclick="copyResult()">ğŸ“‹ ä¸€é”®å¤åˆ¶</button>
      <div id="statusRight" class="status"></div>
    </div>
  </div>

  <script>
    // å®æ—¶å¤„ç†ï¼ˆå¯é€‰ï¼‰
    document.getElementById('inputLog').addEventListener('input', function () {
      if (this.value.split('\n').filter(line => line.trim()).length >= 2) {
        processSql();
      }
    });

    function processSql() {
      const input = document.getElementById('inputLog').value;
      const statusEl = document.getElementById('statusLeft');
      const outputEl = document.getElementById('outputSql');
      statusEl.textContent = '';
      outputEl.value = '';

      const lines = input.split('\n').map(line => line.trim()).filter(line => line);

      if (lines.length < 2) {
        statusEl.textContent = 'âš ï¸ è¯·è¾“å…¥è‡³å°‘ä¸¤è¡Œæ—¥å¿—ï¼šSQL å’Œ Parameters';
        return;
      }

      const sqlLine = lines[0];
      const paramsLine = lines[1];

      let sqlMatch = sqlLine.match(/Preparing: (.+)/i);
      if (!sqlMatch) {
        statusEl.textContent = 'âŒ ç¬¬ä¸€è¡Œå¿…é¡»ä»¥ "Preparing: " å¼€å¤´';
        return;
      }
      let sql = sqlMatch[1].trim();

      let paramsMatch = paramsLine.match(/Parameters: (.+)/i);
      if (!paramsMatch) {
        statusEl.textContent = 'âŒ ç¬¬äºŒè¡Œå¿…é¡»ä»¥ "Parameters: " å¼€å¤´';
        return;
      }
      let rawParams = paramsMatch[1].trim();

      // è§£æå‚æ•°åˆ—è¡¨ï¼ˆæ”¯æŒé€—å·åˆ†éš”ï¼Œå¤„ç†å¸¦æ‹¬å·ç±»å‹ï¼‰
      // ç¤ºä¾‹ï¼š123(Long), abc(String), null, "hello, world"(String)
      let params = [];
      let temp = "";
      let inQuotes = false;

      for (let char of rawParams) {
        if (char === '"') {
          inQuotes = !inQuotes;
          temp += char;
        } else if (char === ',' && !inQuotes) {
          params.push(temp.trim());
          temp = "";
        } else {
          temp += char;
        }
      }
      if (temp.trim()) params.push(temp.trim());

      // æå–æ¯ä¸ªå‚æ•°çš„å€¼å’Œç±»å‹
      const parsedParams = params.map(p => {
        const match = p.match(/^(.+)$$([^)]+)$$$/); // å¦‚ abc(String)
        if (match) {
          let val = match[1].trim();
          const type = match[2].trim();

          if (val.toLowerCase() === 'null') {
            return { value: null, type };
          }

          // å»é™¤åŒ…è£¹çš„åŒå¼•å·ï¼ˆå¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼‰
          if (val.startsWith('"') && val.endsWith('"')) {
            val = val.slice(1, -1);
          }
          return { value: val, type };
        } else {
          // æ— æ³•è§£æç±»å‹ï¼Œé»˜è®¤å½“å­—ç¬¦ä¸²å¤„ç†
          if (p.toLowerCase() === 'null') {
            return { value: null, type: 'Object' };
          }
          return { value: p, type: 'String' };
        }
      });

      // æ›¿æ¢ SQL ä¸­çš„æ¯ä¸€ä¸ª ? ä¸ºå®é™…å€¼
      let finalSql = sql;
      let index = 0;
      const paramValues = parsedParams.map(p => formatValue(p.value, p.type));

      while (finalSql.includes('?') && index < paramValues.length) {
        const val = paramValues[index++];
        finalSql = replaceFirst(finalSql, '?', val);
      }

      if (index < paramValues.length) {
        statusEl.textContent = `âš ï¸ è­¦å‘Šï¼šæœ‰å¤šä½™å‚æ•°æœªä½¿ç”¨ï¼ˆ${paramValues.length - index} ä¸ªï¼‰`;
      } else if (finalSql.includes('?')) {
        statusEl.textContent = `âš ï¸ è­¦å‘Šï¼šSQL ä¸­ä»æœ‰æœªæ›¿æ¢çš„ ?ï¼ˆç¼ºå°‘å‚æ•°ï¼‰`;
      } else {
        statusEl.innerHTML = `âœ… æˆåŠŸæ›¿æ¢ ${index} ä¸ªå‚æ•°`;
        statusEl.className = 'status success';
      }

      outputEl.value = formatFinalSql(finalSql);
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ›¿æ¢ç¬¬ä¸€ä¸ªå‡ºç°çš„å­ä¸²
    function replaceFirst(str, search, replacement) {
      const idx = str.indexOf(search);
      if (idx === -1) return str;
      return str.substring(0, idx) + replacement + str.substring(idx + search.length);
    }

    // æ ¼å¼åŒ–å•ä¸ªå€¼ï¼ˆæ ¹æ®ç±»å‹å†³å®šæ˜¯å¦åŠ å¼•å·ï¼‰
    function formatValue(value, type) {
      if (value === null) return 'NULL';

      type = type.toLowerCase();

      const numberTypes = ['int', 'integer', 'long', 'double', 'float', 'decimal', 'number'];
      const dateTypes = ['timestamp', 'datetime', 'date', 'time'];

      if (numberTypes.some(t => type.includes(t))) {
        return String(value);
      } else if (dateTypes.some(t => type.includes(t))) {
        return `'${value}'`;
      } else {
        // å­—ç¬¦ä¸²æˆ–å…¶ä»–ç±»å‹ï¼ŒåŠ å¼•å·å¹¶è½¬ä¹‰å•å¼•å·
        return `'${String(value).replace(/'/g, "''")}'`;
      }
    }

    // ç®€å•ç¾åŒ– SQLï¼ˆå¤§å†™å…³é”®å­—ï¼‰
    function formatFinalSql(sql) {
      return sql
        .replace(/\bSELECT\b/gi, 'SELECT')
        .replace(/\bFROM\b/gi, 'FROM')
        .replace(/\bWHERE\b/gi, 'WHERE')
        .replace(/\bAND\b/gi, 'AND')
        .replace(/\bOR\b/gi, 'OR')
        .replace(/\bINSERT\b/gi, 'INSERT')
        .replace(/\bUPDATE\b/gi, 'UPDATE')
        .replace(/\bDELETE\b/gi, 'DELETE')
        .replace(/\bVALUES\b/gi, 'VALUES')
        .replace(/\bORDER BY\b/gi, 'ORDER BY')
        .replace(/\bGROUP BY\b/gi, 'GROUP BY')
        .replace(/\bHAVING\b/gi, 'HAVING')
        .replace(/\bJOIN\b/gi, 'JOIN')
        .replace(/\bON\b/gi, 'ON');
    }

    // å¤åˆ¶ç»“æœ
    function copyResult() {
      const output = document.getElementById('outputSql');
      if (!output.value) {
        alert('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹ï¼');
        return;
      }
      output.select();
      document.execCommand('copy');
      const statusEl = document.getElementById('statusRight');
      statusEl.textContent = 'âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼';
      statusEl.className = 'status success';
      setTimeout(() => {
        statusEl.textContent = '';
      }, 2000);
    }
  </script>

</body>
</html>
